/**
 * ã€ä¸»è¦é€²å…¥é»ã€‘ä¸€éµå•Ÿå‹•è‡ªå‹•åŒ–
 */
function runAutomation() {
  const props = PropertiesService.getScriptProperties();
  
  // 1. æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨åŸ·è¡Œä¸­ï¼Œé¿å…é‡è¤‡è§¸ç™¼
  if (props.getProperty('IS_RUNNING') === 'true') {
    SpreadsheetApp.getUi().alert("è‡ªå‹•åŒ–ä»»å‹™æ­£åœ¨èƒŒæ™¯åŸ·è¡Œä¸­ï¼Œè«‹éœå€™çµæœã€‚");
    return;
  }
  
  props.setProperty('IS_RUNNING', 'true');
  createNextTrigger(); // è¨­å®šè‡ªå‹•æ¥é—œè§¸ç™¼å™¨
  mainProcess(); // åŸ·è¡Œä¸»é‚è¼¯
  
  SpreadsheetApp.getUi().alert("âœ… è‡ªå‹•åŒ–å·²å•Ÿå‹•ï¼\nç¨‹å¼å°‡åœ¨èƒŒæ™¯æŒçºŒåŸ·è¡Œï¼ˆåŒ…å«ç´¢å¼•èˆ‡æ¯”å°ï¼‰ã€‚\nå®Œæˆå¾Œæœƒç™¼é€ Email é€šçŸ¥ã€‚æ‚¨å¯ä»¥é—œé–‰æ­¤è¦–çª—ã€‚");
}

/**
 * ã€æ ¸å¿ƒé‚è¼¯åˆ¤æ–·ã€‘è‡ªå‹•åˆ‡æ›ç´¢å¼•æˆ–æ¯”å°éšæ®µ
 */
function mainProcess() {
  const props = PropertiesService.getScriptProperties();
  const isIndexed = props.getProperty('INDEX_COMPLETE');

  try {
    if (!isIndexed) {
      runFolderIndexing();
    } else {
      runFileComparison();
    }
  } catch (e) {
    console.error("åŸ·è¡ŒéŒ¯èª¤: " + e.toString());
    // é‡åˆ°éŒ¯èª¤æ™‚æš«ä¸æ¸…é™¤è§¸ç™¼å™¨ï¼Œè®“ä¸‹æ¬¡å˜—è©¦ä¿®å¾©ï¼Œæˆ–åœ¨æ­¤åŠ å…¥è­¦å ±
  }
}

/**
 * éšæ®µ 1ï¼šå¿«é€Ÿç´¢å¼• (Continuation Token)
 */
function runFolderIndexing() {
  const props = PropertiesService.getScriptProperties();
  const token = props.getProperty('INDEX_TOKEN');
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let indexSheet = ss.getSheetByName('FolderIndex') || ss.insertSheet('FolderIndex');
  
  if (!token && indexSheet.getLastRow() <= 1) {
    indexSheet.clear().appendRow(['Folder ID', 'Folder Name']);
  }

  let folders = token ? DriveApp.continueFolderIterator(token) : DriveApp.getFolders();
  let startTime = new Date().getTime();
  let cache = [];

  while (folders.hasNext()) {
    // åŸ·è¡Œç´„ 4.5 åˆ†é˜å¾Œè‡ªå‹•å„²å­˜ä¸¦é€€å‡ºï¼Œç­‰å¾…è§¸ç™¼å™¨æ¥é—œ
    if (new Date().getTime() - startTime > 270000) {
      saveToSheet(indexSheet, cache);
      props.setProperty('INDEX_TOKEN', folders.getContinuationToken());
      return; 
    }

    let folder = folders.next();
    cache.push([folder.getId(), folder.getName()]);
    if (cache.length >= 500) {
      saveToSheet(indexSheet, cache);
      cache = [];
    }
  }

  saveToSheet(indexSheet, cache);
  props.deleteProperty('INDEX_TOKEN');
  props.setProperty('INDEX_COMPLETE', 'true');
  props.setProperty('CURRENT_ROW', '2');
  console.log("ç´¢å¼•å®Œæˆï¼Œåˆ‡æ›è‡³æ¯”å°éšæ®µ");
}

/**
 * éšæ®µ 2ï¼šæ¯”å°é‡è¤‡æª”æ¡ˆ
 */
function runFileComparison() {
  const props = PropertiesService.getScriptProperties();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const indexSheet = ss.getSheetByName('FolderIndex');
  const resultSheet = ss.getSheetByName('å‰¯æœ¬æ¯”å°æ¸…å–®v5') || ss.insertSheet('å‰¯æœ¬æ¯”å°æ¸…å–®v5');
  
  if (resultSheet.getLastRow() === 0) {
    resultSheet.appendRow(["ç‹€æ…‹", "å‰¯æœ¬åç¨±", "åŸå§‹åç¨±", "å¤§å°ä¸€è‡´", "çˆ¶è³‡æ–™å¤¾", "å»ºç«‹æ™‚é–“", "é€£çµ"]);
  }

  let currentRow = parseInt(props.getProperty('CURRENT_ROW') || '2');
  const lastRow = indexSheet.getLastRow();
  const startTime = new Date().getTime();

  // æ¯æ¬¡è™•ç†ä¸€æ‰¹è³‡æ–™å¤¾
  while (currentRow <= lastRow) {
    if (new Date().getTime() - startTime > 270000) {
      props.setProperty('CURRENT_ROW', currentRow.toString());
      return;
    }

    let folderId = indexSheet.getRange(currentRow, 1).getValue();
    try {
      let folder = DriveApp.getFolderById(folderId);
      checkFilesInside(folder, resultSheet);
    } catch (e) {}
    
    currentRow++;
  }

  // å…¨éƒ¨å®Œæˆ
  completeAll();
}

/**
 * å­å‡½æ•¸ï¼šæª¢æŸ¥æª”æ¡ˆ
 */
function checkFilesInside(folder, sheet) {
  const files = folder.getFiles();
  const fileMap = {};
  const list = [];
  while (files.hasNext()) {
    let f = files.next();
    let n = f.getName();
    list.push(f);
    fileMap[n] = f.getSize();
  }

  list.forEach(f => {
    let name = f.getName();
    let match = name.match(/^(.*)\s\(\d+\)$/) || name.match(/^(.*) çš„å‰¯æœ¬$/);
    if (match && fileMap[match[1]] !== undefined) {
      sheet.appendRow([
        "é‡è¤‡å‰¯æœ¬", name, match[1], 
        (f.getSize() === fileMap[match[1]] ? "æ˜¯" : "å¦"),
        folder.getName(), f.getDateCreated(), f.getUrl()
      ]);
    }
  });
}

/**
 * è¨­å®š 1 åˆ†é˜å¾Œçš„è‡ªå‹•è§¸ç™¼å™¨
 */
function createNextTrigger() {
  deleteTriggers(); // å…ˆæ¸…ç†èˆŠçš„é¿å…å †ç–Š
  ScriptApp.newTrigger('mainProcess')
    .timeBased()
    .after(60 * 1000) 
    .create();
}

/**
 * æ¸…ç†æ‰€æœ‰è§¸ç™¼å™¨
 */
function deleteTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  for (let i = 0; i < triggers.length; i++) {
    ScriptApp.deleteTrigger(triggers[i]);
  }
}

/**
 * å®Œæˆå¾Œçš„çµå°¾å‹•ä½œ
 */
function completeAll() {
  const props = PropertiesService.getScriptProperties();
  deleteTriggers();
  props.deleteAllProperties();
  
  const email = Session.getActiveUser().getEmail();
  MailApp.sendEmail(email, "Google Drive é‡è¤‡æª”æ¡ˆæƒæå®Œæˆ", "æ‚¨å¥½ï¼Œ6è¬å€‹è³‡æ–™å¤¾çš„æƒæä»»å‹™å·²å…¨éƒ¨å®Œæˆï¼Œè«‹æŸ¥çœ‹æ‚¨çš„è©¦ç®—è¡¨ã€‚");
  console.log("ä»»å‹™åœ“æ»¿å®Œæˆ");
}

/**
 * å·¥å…·ï¼šå¯«å…¥è©¦ç®—è¡¨
 */
function saveToSheet(sheet, data) {
  if (data.length > 0) {
    sheet.getRange(sheet.getLastRow() + 1, 1, data.length, data[0].length).setValues(data);
  }
}

/**
 * å»ºç«‹é¸å–®
 */
function onOpen() {
  SpreadsheetApp.getUi().createMenu('ğŸš€ è‡ªå‹•åŒ–æ¸…ç†V5')
    .addItem('â–¶ï¸ å•Ÿå‹•ä¸€éµæƒæ', 'runAutomation')
    .addSeparator()
    .addItem('ğŸ§¹ åœæ­¢ä¸¦é‡ç½®æ‰€æœ‰é€²åº¦', 'completeAll')
    .addToUi();
}
