/**
 * é€²å…¥é»ï¼šä½¿ç”¨è€…æ¯æ¬¡éƒ½é»é¸åŸ·è¡Œé€™å€‹å‡½æ•¸
 */
function smartScanWithResume() {
  const props = PropertiesService.getScriptProperties();
  let folderQueue = props.getProperty('FOLDER_QUEUE');
  
  // åˆå§‹åŒ–ï¼šå¦‚æœæ²’æœ‰é€²åº¦ç´€éŒ„ï¼Œå‰‡é–‹å§‹å»ºç«‹å…¨ç¡¬ç¢Ÿè³‡æ–™å¤¾æ¸…å–®
  if (!folderQueue) {
    const ui = SpreadsheetApp.getUi();
    const response = ui.alert("å°šæœªç™¼ç¾åŸ·è¡Œé€²åº¦ï¼Œæ˜¯å¦é–‹å§‹ã€Œæƒææ‰€æœ‰è³‡æ–™å¤¾ã€ï¼Ÿ\n(é€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“)", ui.ButtonSet.YES_NO);
    if (response !== ui.Button.YES) return;
    
    ui.showModelessDialog(HtmlService.createHtmlOutput("æ­£åœ¨æƒæç›®éŒ„çµæ§‹ï¼Œè«‹ç¨å€™..."), "åˆå§‹åŒ–ä¸­");
    const allFolderIds = [];
    buildFolderList(DriveApp.getRootFolder(), allFolderIds);
    props.setProperty('FOLDER_QUEUE', JSON.stringify(allFolderIds));
    folderQueue = JSON.stringify(allFolderIds);
    ui.alert("ç›®éŒ„çµæ§‹æƒæå®Œæˆï¼Œå…± " + allFolderIds.length + " å€‹è³‡æ–™å¤¾ã€‚è«‹å†æ¬¡é»æ“ŠåŸ·è¡Œä»¥é–‹å§‹æ¯”å°ã€‚");
    return;
  }

  // é–‹å§‹æ­£å¼æ¯”å°
  const startTime = new Date().getTime();
  const queue = JSON.parse(folderQueue);
  const totalOriginal = queue.length;
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName('å‰¯æœ¬æ¯”å°æ¸…å–®v3') || ss.insertSheet('å‰¯æœ¬æ¯”å°æ¸…å–®v3');

  console.log("é–‹å§‹æ¯”å°é€²åº¦ï¼Œå‰©é¤˜è³‡æ–™å¤¾ï¼š" + totalOriginal);

  while (queue.length > 0) {
    // æª¢æŸ¥æ˜¯å¦æ¥è¿‘ 6 åˆ†é˜ (330,000 æ¯«ç§’)ï¼Œé ç•™ 30 ç§’ç·©è¡
    const currentTime = new Date().getTime();
    if (currentTime - startTime > 330000) {
      props.setProperty('FOLDER_QUEUE', JSON.stringify(queue)); // å„²å­˜å‰©é¤˜é€²åº¦
      SpreadsheetApp.getUi().alert("åŸ·è¡Œæ™‚é–“æ¥è¿‘ 6 åˆ†é˜ä¸Šé™ã€‚\nç›®å‰é€²åº¦å·²å„²å­˜ï¼Œå‰©é¤˜ " + queue.length + " å€‹è³‡æ–™å¤¾ã€‚è«‹ç¨å¾Œå†æ¬¡åŸ·è¡Œã€‚");
      return;
    }

    const currentFolderId = queue.shift(); // å–å‡ºç¬¬ä¸€å€‹è³‡æ–™å¤¾
    try {
      const folder = DriveApp.getFolderById(currentFolderId);
      processSingleFolder(folder, sheet);
    } catch (e) {
      console.error("ç„¡æ³•å­˜å–è³‡æ–™å¤¾ ID: " + currentFolderId + "ï¼ŒéŒ¯èª¤ï¼š" + e.message);
    }
  }

  // å…¨éƒ¨å®Œæˆå¾Œæ¸…é™¤ç´€éŒ„
  props.deleteProperty('FOLDER_QUEUE');
  SpreadsheetApp.getUi().alert("ğŸ‰ æ­å–œï¼å…¨é›²ç«¯ç¡¬ç¢Ÿæƒæå®Œæˆã€‚");
}

/**
 * éè¿´å»ºç«‹è³‡æ–™å¤¾ ID æ¸…å–®
 */
function buildFolderList(folder, list) {
  list.push(folder.getId());
  const subFolders = folder.getFolders();
  while (subFolders.hasNext()) {
    buildFolderList(subFolders.next(), list);
  }
}

/**
 * è™•ç†å–®ä¸€è³‡æ–™å¤¾çš„æ¯”å°é‚è¼¯
 */
function processSingleFolder(folder, sheet) {
  const files = folder.getFiles();
  const fileArray = [];
  const fileDataMap = {};
  const path = getFolderPath(folder);

  while (files.hasNext()) {
    let file = files.next();
    let name = file.getName();
    fileArray.push(file);
    fileDataMap[name] = { size: file.getSize() };
  }

  fileArray.forEach(file => {
    const fileName = file.getName();
    const match = fileName.match(/^(.*)\s\(\d+\)$/) || fileName.match(/^(.*) çš„å‰¯æœ¬$/);

    if (match) {
      const baseName = match[1];
      if (fileDataMap[baseName]) {
        const original = fileDataMap[baseName];
        const currentSize = file.getSize();
        sheet.appendRow([
          "åµæ¸¬åˆ°å‰¯æœ¬",
          path,
          fileName,
          baseName,
          (currentSize === original.size) ? "ä¸€è‡´" : "ä¸ä¸€è‡´",
          currentSize || "-",
          original.size || "-",
          file.getDateCreated(),
          file.getUrl()
        ]);
      }
    }
  });
}

/**
 * è¼”åŠ©å‡½æ•¸ï¼šå–å¾—å®Œæ•´è·¯å¾‘
 */
function getFolderPath(folder) {
  let path = "/" + folder.getName();
  let parent = folder.getParents();
  while (parent.hasNext()) {
    folder = parent.next();
    path = "/" + folder.getName() + path;
    parent = folder.getParents();
  }
  return path;
}

/**
 * é‡è¨­é€²åº¦å‡½æ•¸ (è¬ä¸€æƒ³é‡æ–°é–‹å§‹æƒææ™‚æ‰‹å‹•åŸ·è¡Œ)
 */
function resetProgress() {
  PropertiesService.getScriptProperties().deleteProperty('FOLDER_QUEUE');
  Browser.msgBox("åŸ·è¡Œé€²åº¦å·²æ¸…é™¤ã€‚");
}
