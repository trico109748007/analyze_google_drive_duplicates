/**
 * ç¸½é€²å…¥é»
 */
function mainEntry() {
  const props = PropertiesService.getScriptProperties();
  const finalQueue = props.getProperty('FINAL_QUEUE'); // æœ€çµ‚è¦è™•ç†çš„æª”æ¡ˆæ¯”å°æ¸…å–®
  const folderStack = props.getProperty('FOLDER_STACK'); // æƒæç›®éŒ„ç”¨çš„å †ç–Š

  // éšæ®µ 1ï¼šå¦‚æœé€£ç›®éŒ„æ¸…å–®éƒ½é‚„æ²’å»ºç«‹å®Œ
  if (!finalQueue) {
    buildFolderListIncremental();
    return;
  }

  // éšæ®µ 2ï¼šç›®éŒ„æ¸…å–®å·²å®Œæˆï¼Œé–‹å§‹æ¯”å°æª”æ¡ˆ
  smartScanWithResume();
}

/**
 * å¢é‡å¼å»ºç«‹è³‡æ–™å¤¾æ¸…å–® (è§£æ±ºç›®éŒ„æƒæè¶…æ™‚)
 */
function buildFolderListIncremental() {
  const props = PropertiesService.getScriptProperties();
  let stack = JSON.parse(props.getProperty('FOLDER_STACK') || '[]');
  let finalList = JSON.parse(props.getProperty('FINAL_LIST') || '[]');
  const startTime = new Date().getTime();

  // åˆå§‹åŒ–å †ç–Šï¼šå°‡æ ¹ç›®éŒ„æ”¾å…¥
  if (stack.length === 0 && finalList.length === 0) {
    stack.push(DriveApp.getRootFolder().getId());
  }

  while (stack.length > 0) {
    // 4åˆ†é˜ä¿è­·æ©Ÿåˆ¶
    if (new Date().getTime() - startTime > 300000) {
      props.setProperty('FOLDER_STACK', JSON.stringify(stack));
      props.setProperty('FINAL_LIST', JSON.stringify(finalList));
      SpreadsheetApp.getUi().alert("ç›®éŒ„å¤ªå¤šï¼Œæ­£åœ¨åˆ†æ®µè®€å–çµæ§‹...\nç›®å‰å·²æ‰¾åˆ° " + finalList.length + " å€‹è³‡æ–™å¤¾ï¼Œè«‹å†æ¬¡åŸ·è¡Œã€‚");
      return;
    }

    const currentId = stack.pop();
    finalList.push(currentId);

    try {
      const subFolders = DriveApp.getFolderById(currentId).getFolders();
      while (subFolders.hasNext()) {
        stack.push(subFolders.next().getId());
      }
    } catch (e) {
      console.warn("è·³éç„¡æ³•å­˜å–çš„è³‡æ–™å¤¾: " + currentId);
    }
  }

  // æƒæç›®éŒ„å®Œæˆï¼Œè½‰ç§»åˆ°æ¯”å°éšŠåˆ—
  props.setProperty('FINAL_QUEUE', JSON.stringify(finalList));
  props.deleteProperty('FOLDER_STACK');
  props.deleteProperty('FINAL_LIST');
  SpreadsheetApp.getUi().alert("âœ… æ‰€æœ‰ç›®éŒ„çµæ§‹æƒæå®Œæˆï¼å…± " + finalList.length + " å€‹è³‡æ–™å¤¾ã€‚ä¸‹æ¬¡åŸ·è¡Œå°‡é–‹å§‹æ¯”å°æª”æ¡ˆå…§å®¹ã€‚");
}

/**
 * æª”æ¡ˆæ¯”å°é‚è¼¯ (æ¥çºŒä¸Šä¸€ç‰ˆï¼Œä½†æ”¹è®€ FINAL_QUEUE)
 */
function smartScanWithResume() {
  const props = PropertiesService.getScriptProperties();
  let queue = JSON.parse(props.getProperty('FINAL_QUEUE'));
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let sheet = ss.getSheetByName('å‰¯æœ¬æ¯”å°æ¸…å–®v4') || ss.insertSheet('å‰¯æœ¬æ¯”å°æ¸…å–®v4');
  const startTime = new Date().getTime();

  while (queue.length > 0) {
    // 4.5 åˆ†é˜ä¿è­·
    if (new Date().getTime() - startTime > 330000) {
      props.setProperty('FINAL_QUEUE', JSON.stringify(queue));
      SpreadsheetApp.getUi().alert("åŸ·è¡Œæ™‚é–“åˆ°ã€‚å‰©é¤˜ " + queue.length + " å€‹è³‡æ–™å¤¾ã€‚è«‹å†æ¬¡åŸ·è¡Œã€‚");
      return;
    }

    const currentId = queue.shift();
    try {
      const folder = DriveApp.getFolderById(currentId);
      processSingleFolder(folder, sheet);
    } catch (e) {}
  }

  props.deleteProperty('FINAL_QUEUE');
  SpreadsheetApp.getUi().alert("ğŸ‰ å…¨ç¡¬ç¢Ÿå‰¯æœ¬æƒæå®Œæˆï¼");
}

/**
 * è™•ç†å–®ä¸€è³‡æ–™å¤¾æ¯”å° (åŒå‰ä¸€ç‰ˆ)
 */
function processSingleFolder(folder, sheet) {
  const files = folder.getFiles();
  const fileArray = [];
  const fileDataMap = {};
  const path = getFolderPath(folder);

  while (files.hasNext()) {
    let file = files.next();
    let name = file.getName();
    fileArray.push(file);
    fileDataMap[name] = { size: file.getSize() };
  }

  fileArray.forEach(file => {
    const fileName = file.getName();
    const match = fileName.match(/^(.*)\s\(\d+\)$/) || fileName.match(/^(.*) çš„å‰¯æœ¬$/);
    if (match && fileDataMap[match[1]]) {
      const original = fileDataMap[match[1]];
      sheet.appendRow(["é‡è¤‡å‰¯æœ¬", path, fileName, match[1], (file.getSize() === original.size ? "ä¸€è‡´" : "ä¸ä¸€è‡´"), file.getSize(), original.size, file.getDateCreated(), file.getUrl()]);
    }
  });
}

function getFolderPath(folder) {
  let path = "/" + folder.getName();
  try {
    let parent = folder.getParents();
    while (parent.hasNext()) {
      folder = parent.next();
      path = "/" + folder.getName() + path;
      parent = folder.getParents();
    }
  } catch(e) {}
  return path;
}

function resetAll() {
  const props = PropertiesService.getScriptProperties();
  props.deleteProperty('FOLDER_STACK');
  props.deleteProperty('FINAL_LIST');
  props.deleteProperty('FINAL_QUEUE');
  Browser.msgBox("æ‰€æœ‰é€²åº¦å·²é‡ç½®ã€‚");
}
