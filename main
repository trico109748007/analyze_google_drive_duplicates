/**
 * ==============================================================================
 * Google Drive å‰¯æœ¬æƒæå°ˆå®¶ (6è¬è³‡æ–™å¤¾å¤§å®¹é‡ç‰ˆ)
 * åŠŸèƒ½ï¼šè‡ªå‹•ç´¢å¼•ç›®éŒ„ -> é€ä¸€æ¯”å°å‰¯æœ¬ -> é¡¯ç¤ºå³æ™‚é€²åº¦ -> Email é€šçŸ¥
 * ==============================================================================
 */

// --- ä»‹é¢è¨­å®š ---

function onOpen() {
  SpreadsheetApp.getUi().createMenu('ğŸš€ é›²ç«¯æ¸…ç†å·¥å…·V6')
    .addItem('â–¶ï¸ å•Ÿå‹•ä¸€éµè‡ªå‹•åŒ–æƒæ', 'runAutomation')
    .addSeparator()
    .addItem('ğŸ§¹ åœæ­¢ä¸¦é‡ç½®é€²åº¦', 'resetAllProgress')
    .addToUi();
}

/**
 * å•Ÿå‹•é»
 */
function runAutomation() {
  const props = PropertiesService.getScriptProperties();
  
  if (props.getProperty('IS_RUNNING') === 'true') {
    SpreadsheetApp.getUi().alert("ä»»å‹™å·²åœ¨èƒŒæ™¯åŸ·è¡Œä¸­ï¼Œè«‹æª¢è¦–ã€ŒStatusPanelã€åˆ†é ã€‚");
    return;
  }
  
  const ui = SpreadsheetApp.getUi();
  const resp = ui.alert("å°‡é–‹å§‹åŸ·è¡Œã€Œå…¨ç¡¬ç¢Ÿæƒæã€ï¼Œé è¨ˆè™•ç† 6 è¬å€‹è³‡æ–™å¤¾ã€‚\nç¨‹å¼æœƒè‡ªå‹•æ¥é—œï¼Œå®Œæˆå¾Œç™¼é€ Emailã€‚\næ˜¯å¦å•Ÿå‹•ï¼Ÿ", ui.ButtonSet.YES_NO);
  
  if (resp === ui.Button.YES) {
    props.setProperty('IS_RUNNING', 'true');
    updateStatus("å•Ÿå‹•ä¸­", "æº–å‚™é–‹å§‹ä»»å‹™...");
    createNextTrigger(); // è¨­å®šè‡ªå‹•æ¥é—œ
    mainProcess(); // å•Ÿå‹•ä¸»ç¨‹å¼
  }
}

/**
 * ä¸»é‚è¼¯åˆ†é…
 */
function mainProcess() {
  const props = PropertiesService.getScriptProperties();
  const isIndexed = props.getProperty('INDEX_COMPLETE');

  try {
    if (!isIndexed) {
      runFolderIndexing();
    } else {
      runFileComparison();
    }
  } catch (e) {
    console.error("åŸ·è¡Œç•°å¸¸: " + e.toString());
    updateStatus("åŸ·è¡ŒéŒ¯èª¤", e.toString());
    // é‡åˆ°éŒ¯èª¤æš«åœåŸ·è¡Œï¼Œä¸¦å°‡åŸ·è¡Œæ¨™è¨˜è¨­ç‚º false ä»¥ä¾¿ä½¿ç”¨è€…æª¢ä¿®
    props.setProperty('IS_RUNNING', 'false');
    deleteTriggers();
  }
}

// --- éšæ®µ 1ï¼šç›®éŒ„ç´¢å¼• ---

function runFolderIndexing() {
  const props = PropertiesService.getScriptProperties();
  const token = props.getProperty('INDEX_TOKEN');
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let indexSheet = ss.getSheetByName('FolderIndex') || ss.insertSheet('FolderIndex');
  
  if (!token && indexSheet.getLastRow() <= 1) {
    indexSheet.clear().appendRow(['Folder ID', 'Folder Name']);
    indexSheet.setFrozenRows(1);
  }

  let folders = token ? DriveApp.continueFolderIterator(token) : DriveApp.getFolders();
  let startTime = new Date().getTime();
  let cache = [];

  while (folders.hasNext()) {
    // 4åˆ†é˜ä¸­æ–·æ©Ÿåˆ¶ (GAS ä¸Šé™ 6 åˆ†é˜ï¼Œé ç•™å®‰å…¨ç·©è¡)
    if (new Date().getTime() - startTime > 240000) {
      saveToSheet(indexSheet, cache);
      props.setProperty('INDEX_TOKEN', folders.getContinuationToken());
      updateStatus("ç´¢å¼•ä¸­", "å·²æ‰¾åˆ° " + indexSheet.getLastRow() + " å€‹è³‡æ–™å¤¾ï¼Œç¨å¾Œæ¥çºŒ...");
      return; 
    }

    let folder = folders.next();
    cache.push([folder.getId(), folder.getName()]);
    
    if (cache.length >= 500) {
      saveToSheet(indexSheet, cache);
      updateStatus("ç´¢å¼•ä¸­", "æ­£åœ¨æƒæç›®éŒ„...ç›®å‰ç´¯è¨ˆ: " + indexSheet.getLastRow());
      cache = [];
    }
  }

  saveToSheet(indexSheet, cache);
  props.deleteProperty('INDEX_TOKEN');
  props.setProperty('INDEX_COMPLETE', 'true');
  props.setProperty('CURRENT_ROW', '2');
  updateStatus("ç´¢å¼•å®Œæˆ", "ç›®éŒ„å·²å…¨æ•¸æƒæã€‚å³å°‡é€²å…¥æª”æ¡ˆæ¯”å°ã€‚");
}

// --- éšæ®µ 2ï¼šæª”æ¡ˆæ¯”å° ---

function runFileComparison() {
  const props = PropertiesService.getScriptProperties();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const indexSheet = ss.getSheetByName('FolderIndex');
  const resultSheet = ss.getSheetByName('å‰¯æœ¬æ¯”å°æ¸…å–®V6') || ss.insertSheet('å‰¯æœ¬æ¯”å°æ¸…å–®V6');
  
  if (resultSheet.getLastRow() === 0) {
    resultSheet.appendRow(["ç‹€æ…‹", "å‰¯æœ¬æª”å", "åŸå§‹æª”å", "å¤§å°ä¸€è‡´", "çˆ¶è³‡æ–™å¤¾è·¯å¾‘", "å‰¯æœ¬å»ºç«‹æ™‚é–“", "æª”æ¡ˆé€£çµ"]);
    resultSheet.setFrozenRows(1);
  }

  let currentRow = parseInt(props.getProperty('CURRENT_ROW') || '2');
  const lastRow = indexSheet.getLastRow();
  const startTime = new Date().getTime();

  while (currentRow <= lastRow) {
    // 4.5 åˆ†é˜ä¸­æ–·æ©Ÿåˆ¶
    if (new Date().getTime() - startTime > 270000) {
      props.setProperty('CURRENT_ROW', currentRow.toString());
      updateStatus("æ¯”å°ä¸­", "ç›®å‰é€²åº¦: " + currentRow + " / " + lastRow);
      return;
    }

    let folderId = indexSheet.getRange(currentRow, 1).getValue();
    try {
      let folder = DriveApp.getFolderById(folderId);
      checkFilesInside(folder, resultSheet);
    } catch (e) {
      console.warn("è·³éè³‡æ–™å¤¾ ID: " + folderId + " (åŸå› : " + e.message + ")");
    }
    
    if (currentRow % 50 === 0) {
      updateStatus("æ¯”å°ä¸­", currentRow + " / " + lastRow);
    }
    currentRow++;
  }

  completeAllTask();
}

/**
 * å‰¯æœ¬æ¯”å°é‚è¼¯ (åŒä¸€è³‡æ–™å¤¾å…§)
 */
function checkFilesInside(folder, sheet) {
  const files = folder.getFiles();
  const fileMap = {}; // å­˜æ”¾æª”æ¡ˆåç¨±èˆ‡å¤§å°çš„æ˜ å°„
  const list = [];
  
  while (files.hasNext()) {
    let f = files.next();
    let n = f.getName();
    list.push(f);
    fileMap[n] = f.getSize();
  }

  list.forEach(f => {
    let name = f.getName();
    // åµæ¸¬ "(1)" æˆ– "çš„å‰¯æœ¬" çµå°¾
    let match = name.match(/^(.*)\s\(\d+\)$/) || name.match(/^(.*) çš„å‰¯æœ¬$/);
    
    if (match) {
      let baseName = match[1];
      // æª¢æŸ¥åŒç›®éŒ„ä¸‹æ˜¯å¦å­˜åœ¨åŸå§‹æª”å
      if (fileMap[baseName] !== undefined) {
        sheet.appendRow([
          "é‡è¤‡å‰¯æœ¬", 
          name, 
          baseName, 
          (f.getSize() === fileMap[baseName] ? "ä¸€è‡´" : "ä¸ä¸€è‡´"),
          folder.getName(), 
          f.getDateCreated(), 
          f.getUrl()
        ]);
      }
    }
  });
}

// --- ç³»çµ±åŠŸèƒ½ ---

function updateStatus(stage, detail) {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  let statusSheet = ss.getSheetByName('StatusPanel') || ss.insertSheet('StatusPanel');
  
  if (statusSheet.getLastRow() === 0) {
    statusSheet.getRange("A1:B1").setValues([["é …ç›®", "æ•¸å€¼"]]).setFontWeight("bold").setBackground("#f3f3f3");
    statusSheet.getRange("A2:A6").setValues([["ç›®å‰éšæ®µ"], ["ç´¯è¨ˆç´¢å¼•ç›®éŒ„"], ["ç›®å‰æ¯”å°ç›®éŒ„"], ["ç¸½é€²åº¦ %"], ["æœ€å¾Œæ›´æ–°æ™‚é–“"]]);
    statusSheet.setColumnWidth(1, 150);
    statusSheet.setColumnWidth(2, 400);
  }
  
  const now = Utilities.formatDate(new Date(), "GMT+8", "yyyy-MM-dd HH:mm:ss");
  if (stage) statusSheet.getRange("B2").setValue(stage);
  if (detail) {
    if (stage.includes("ç´¢å¼•")) statusSheet.getRange("B3").setValue(detail);
    if (stage.includes("æ¯”å°")) statusSheet.getRange("B4").setValue(detail);
  }
  
  if (stage === "æ¯”å°ä¸­") {
    const lastRow = ss.getSheetByName('FolderIndex').getLastRow() - 1;
    const current = parseInt(detail.split(" / ")[0]);
    statusSheet.getRange("B5").setValue(((current / lastRow) * 100).toFixed(2) + "%");
  }
  
  statusSheet.getRange("B6").setValue(now);
}

function createNextTrigger() {
  deleteTriggers();
  ScriptApp.newTrigger('mainProcess')
    .timeBased()
    .everyMinutes(1)
    .create();
}

function deleteTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(t => ScriptApp.deleteTrigger(t));
}

function saveToSheet(sheet, data) {
  if (data.length > 0) {
    sheet.getRange(sheet.getLastRow() + 1, 1, data.length, data[0].length).setValues(data);
  }
}

function completeAllTask() {
  const props = PropertiesService.getScriptProperties();
  deleteTriggers();
  props.setProperty('IS_RUNNING', 'false');
  props.deleteProperty('INDEX_COMPLETE');
  props.deleteProperty('CURRENT_ROW');
  
  updateStatus("âœ… ä»»å‹™å®Œæˆ", "æ‰€æœ‰è³‡æ–™å¤¾æƒæå®Œç•¢");
  
  const email = Session.getActiveUser().getEmail();
  MailApp.sendEmail(email, "Google Drive å‰¯æœ¬æƒæå®Œæˆ", "æ‚¨å¥½ï¼Œé›²ç«¯ç¡¬ç¢Ÿå‰¯æœ¬æƒæä»»å‹™å·²å…¨éƒ¨å®Œæˆï¼Œè«‹æª¢è¦–è©¦ç®—è¡¨çµæœã€‚");
}

function resetAllProgress() {
  const props = PropertiesService.getScriptProperties();
  deleteTriggers();
  props.deleteAllProperties();
  const ui = SpreadsheetApp.getUi();
  ui.alert("é€²åº¦å·²é‡ç½®ã€‚è‹¥è¦é‡æ–°æƒæï¼Œè«‹å†æ¬¡é»é¸ã€Œå•Ÿå‹•ä¸€éµè‡ªå‹•åŒ–æƒæã€ã€‚");
}
